---
title: "Interfacing with ERIC"
author: "Tim Ransom"
date: "10/22/2021"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Search terms

We're representing our search terms as a list of lists, where the top level elements
are AND'd and the lower level elements are OR'd. For example: ((a, b, c), (d, e))
represents "a OR b OR c" AND "d OR e"

Here's the full list of terms we're going to make our queries out of:
```{r}
search_terms <- list(list("community college", "higher education", "postsecondary education"),
                     list("pandemic", "COVID-19"),
                     list("online courses", "online learning",
                        "educational technology", "distance education", "electronic learning"),
                     list("hands on", "lab"),
                     list("FAA", "part 147"))
```


### Powerset construction

We need to try all the combinations of our search terms, which mathematically
is the cartesian product of the powersets of our full list above.
```{r}
library(rje)
library(set6)
powerset <- powerSet(search_terms)
mapply(powerSet, search_terms)
#cartesian product the sets together

```


## Eric communications

We use a couple functions to talk to the ERIC api, one to format the query for
the database request and one to talk to ERIC.

```{r}
get_eric_json <- function(encoded_url) {
  # test_url <- "https://api.ies.ed.gov/eric/?search=subject%3A%22community%20college%22%20peerreviewed%3AT&format=json&rows=20000"
  library(curl)
  library(rjson)

  # variable left out for future caching opportunity
  req <- curl_fetch_memory(encoded_url)
  return(fromJSON(rawToChar(req$content)))

}


create_eric_url <- function(search_terms) {
  library(urltools)

  eric_base_url <- "https://api.ies.ed.gov/eric/"
  format <- "json"
  rows <- 2000
  start <- 0
  fields <- list(c("peerreviewed", "'T'"))
  # All possible fields can be found here: https://eric.ed.gov/?api#/default/get_eric_
  
  formatted_terms <- paste(mapply(function(x) {paste(unlist(x), collapse = " OR ")}, search_terms), collapse = " AND ")
  
  formatted_fields <- paste(mapply(function(x) {paste(unlist(x), collapse = ":")}, fields), collapse = " ")
  
  unencoded_url <- paste(eric_base_url, 
                           "?search=", formatted_terms, 
                           "&format=", format, 
                           "&start=", start,
                           "&rows=", rows, 
                           "&fields=", formatted_fields, 
                           sep="")
  
  return(URLencode(unencoded_url)) # url_encode encodes too much and breaks the api but this function works
}
```

## Inputs and Outputs

Just a button that executes a hard coded ERIC search query, which is then displayed below

```{r eruptions, echo=FALSE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20),
  sliderInput("bw_adjust", label = "Bandwidth adjustment:",
              min = 0.2, max = 2, value = 1, step = 0.2)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")

  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```


## scratch space

Generated curl command from the eric api interactive builder:
curl -X GET "https://api.ies.ed.gov/eric/?search=subject%3A%22community%20college%22%20peerreviewed%3AT&format=json&rows=20000" -H  "accept: */*"



